generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Usersex {
  Male
  Female
}

model Admin {
  id       String @id @default(cuid())
  userName String
  email    String @unique
}

model Department {
  id              String           @id @default(cuid())
  name            String           @unique
  supervisorId    String?
  supervisor      Teacher?         @relation("DepartmentSupervisor", fields: [supervisorId], references: [id], onDelete: SetNull)
  subjects        Subject[]
  students        Student[]
  announcements   Announcement[]
  events          Event[]
  examDepartments ExamDepartment[]
  exam            Exam?            @relation(fields: [examId], references: [id])
  examId          Int?
}

model Grade {
  id       String    @id @default(cuid())
  name     String    @unique
  subjects Subject[]
}

model Subject {
  id           Int     @id @default(autoincrement())
  name         String  @unique
  gradeId      String?

  grade      Grade?      @relation(fields: [gradeId], references: [id])
  department Department[]

  assignments Assignment[]
  attendance  Attendance[]
  classrooms  Classroom[]
  exams       Exam[]
  results     Result[]
  timetables  Timetable[]
  students    Student[]
  teachers    Teacher[]
}

model Student {
  id           String     @id @default(cuid())
  username     String     @unique
  email        String     @unique
  age          Int
  address      String
  phoneNumber  String     @unique
  firstName    String
  lastName     String
  image        String?
  sex          Usersex
  createdAt    DateTime   @default(now())
  parentId     String?
  departmentId String
  gradeId      String?
  levelId      Int
  matricule    String? @unique
  DateOfBirth  DateTime?
  department   Department @relation(fields: [departmentId], references: [id])
  parent       Parent?    @relation(fields: [parentId], references: [id])
  level        Level      @relation( fields: [levelId], references: [id])

  attendance Attendance[]
  fees       Fee[]
  results    Result[]
  courses    Subject[]
}

model Level {
   id        Int  @id @default(autoincrement())
   LevelName  String @unique
   student   Student[]
   exam     Exam[]
   
}
model Teacher {
  id          String       @id @default(cuid())
  username    String       @unique
  email       String       @unique
  address     String
  bloodGroup  String?
  phoneNumber String       @unique
  firstName   String
  lastName    String
  sex         Usersex
  image       String?
  teachersId  String       @unique
  DateOfBirth DateTime?
  courses     Subject[]
  department  Department[] @relation("DepartmentSupervisor")
}

model Parent {
  id          String  @id @default(cuid())
  username    String  @unique
  email       String  @unique
  sex         Usersex
  address     String
  phoneNumber String  @unique
  firstName   String
  lastName    String

  students Student[]
}

model Classroom {
  id       String  @id @default(cuid())
  name     String  @unique
  courseId Int
  exams    Exam[]
  course   Subject[]
}

model Event {
  id           String   @id @default(cuid())
  name         String   @unique
  startDate    DateTime
  endDate      DateTime
  description  String
  departmentId String?

  department Department? @relation(fields: [departmentId], references: [id])
}

model Exam {
  id              Int              @id @default(autoincrement())
  name            String           @unique       
  title           String
  startDate       DateTime
  endDate         DateTime
  courseId        Int
  ClassRoomId     String
  schoolYear      String
  DepartmentId    String
  classroom       Classroom        @relation(fields: [ClassRoomId], references: [id])
  depertment      Department[]
  course          Subject          @relation(fields: [courseId], references: [id])
  levelId   Int
  level       Level @relation( fields: [levelId], references: [id])
  results         Result[]
  examDepartments ExamDepartment[]
}

model ExamDepartment {
  examId       Int
  departmentId String

  exam       Exam       @relation(fields: [examId], references: [id] , onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id])

  @@id([examId, departmentId]) // composite PK
}

model Attendance {
  id        Int      @id @default(autoincrement())
  present   Boolean
  date      DateTime
  status    String
  courseId  Int
  studentId String

  course  Subject @relation(fields: [courseId], references: [id])
  student Student @relation(fields: [studentId], references: [id])
}

model Assignment {
  id        Int      @id @default(autoincrement())
  title     String
  startDate DateTime
  dueDate   DateTime
  courseId  Int

  course Subject @relation(fields: [courseId], references: [id])
}

model Result {
  id        Int      @id @default(autoincrement())
  CA        Int
  Exam      Int
  total     Int
  date      DateTime
  studentId String
  courseId  Int
  examId    Int?

  course  Subject @relation(fields: [courseId], references: [id])
  exam    Exam?   @relation(fields: [examId], references: [id] , onDelete: SetNull)
  student Student @relation(fields: [studentId], references: [id])
   @@unique([studentId, courseId])
}

model Timetable {
  id        String   @id @default(cuid())
  courseId  Int
  startTime DateTime
  endTime   DateTime
  day       String

  course Subject @relation(fields: [courseId], references: [id])
}

model Notification {
  id      String   @id @default(cuid())
  title   String
  message String
  date    DateTime
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  message    String
  date       DateTime
}

model Fee {
  id        String   @id @default(cuid())
  studentId String
  amount    Float
  dueDate   DateTime
  status    String

  student Student @relation(fields: [studentId], references: [id])
}

model Announcement {
  id           String   @id @default(cuid())
  title        String
  message      String   @db.Text
  date         DateTime @default(now())
  departmentId String?

  department Department? @relation(fields: [departmentId], references: [id])
}
